{% extends 'layouts/base_layout.html' %}


{% block title %}{{ subject.name }}{% endblock %}


{% block base_layout %}
<div class="max-w-screen-xl py-6 px-4 mx-auto grid gap-8">
    <div class="grid gap-8 border border-border-200 rounded-xl p-4">
        <!-- Пән және орташа прогресстер -->
        <div class="grid gap-4 border-b border-border-200">
            <div class="flex justify-between items-center">
                <h1 class="text-xl md:text-2xl lg:text-3xl xl:text-4xl font-medium">{{ subject.name }}</h1>
                <form method="get" class="flex flex-wrap gap-2 items-center">
                    <!-- Сынып таңдауы -->
                    <select 
                        name="class" 
                        class="w-42 border border-border-200 p-2 rounded-lg"
                        onchange="this.form.submit()"
                    >
                        <option value="">Барлық сыныптар</option>
                        {% for code, name in available_classes %}
                            <option value="{{ code }}" {% if code == selected_class %}selected{% endif %}>
                                {{ name }}
                            </option>
                        {% endfor %}
                    </select>
                    <!-- Тоқсан таңдауы -->
                    <select 
                        name="quarter"
                        class="w-28 border border-border-200 p-2 rounded-lg"
                        onchange="this.form.submit()"
                    >
                        {% for q in quarters %}
                            <option value="{{ q }}" {% if q == selected_quarter %}selected{% endif %}>
                                {{ q }} тоқсан
                            </option>
                        {% endfor %}
                    </select>
                    <!-- Іздеу батырмасы қажет болмаса, алып таста -->
                    <noscript><button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg">Қолдану</button></noscript>
                </form>
            </div>

            <!-- Статистика -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="grid gap-2 p-4 rounded-lg border border-border-200">
                    <h3 class="text-xl font-medium">Бөлімдер</h3>
                    <div class="flex gap-4">
                        {% with percent=generics.completed_chapters|divisibleby:generics.total_chapters %}{% endwith %}
                        {% if generics.total_chapters %}
                            {% widthratio generics.completed_chapters generics.total_chapters 100 as percent %}
                            <div 
                                class="radial-progress bg-secondary-50 text-2xl text-primary-600"
                                style="--value: {{ percent }}; --size: 6rem;" 
                                aria-valuenow="{{ percent }}" role="progressbar"
                            >
                                {{ percent }}%
                            </div>
                        {% else %}
                            <p class="text-muted">Мәлімет жоқ</p>
                        {% endif %}

                        <div class="text-muted">
                            <span>Барлығы: {{ generics.total_chapters }}</span><br>
                            <span>Орындалған: {{ generics.completed_chapters }}</span>
                        </div>
                    </div>
                </div>

                <div class="grid gap-2 p-4 rounded-lg border border-border-200">
                    <h3 class="text-xl font-medium">Сабақтар</h3>
                    <div class="flex gap-4">
                        {% if generics.total_lessons %}
                            {% widthratio generics.completed_lessons generics.total_lessons 100 as percent %}
                            <div 
                                class="radial-progress bg-secondary-50 text-2xl text-primary-600"
                                style="--value: {{ percent }}; --size: 6rem;" 
                                aria-valuenow="{{ percent }}" role="progressbar"
                            >
                                {{ percent }}%
                            </div>
                        {% else %}
                            <p class="text-muted">Мәлімет жоқ</p>
                        {% endif %}
                        <div class="text-muted">
                            <span>Барлығы: {{ generics.total_lessons }}</span><br>
                            <span>Орындалған: {{ generics.completed_lessons }}</span>
                        </div>
                    </div>
                </div>

                <div class="grid gap-2 p-4 rounded-lg border border-border-200">
                    <h3 class="text-xl font-medium">Орташа прогресс</h3>
                    <div class="flex gap-4">
                        <div
                            class="radial-progress bg-secondary-50 text-2xl text-primary-600"
                            style="--value: {{ generics.user_subjects_avg_percentage|floatformat:0 }}; --size: 6rem;" 
                            aria-valuenow="{{ generics.user_subjects_avg_percentage|floatformat:0 }}" role="progressbar"
                        >
                            {{ generics.user_subjects_avg_percentage|floatformat:0 }}%
                        </div>
                        <div class="text-muted">
                            <span>Толығырақ: {{ generics.user_subjects_avg_percentage }}%</span><br>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col gap-2 p-4 rounded-lg border border-border-200">
                    <h3 class="text-xl font-medium">Орташа баға</h3>
                    <div class="flex gap-2 justify-center w-20 items-center py-2 rounded-lg bg-secondary-100">
                        <svg 
                            class="w-6 h-6 text-amber-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24"
                            height="24" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M13.849 4.22c-.684-1.626-3.014-1.626-3.698 0L8.397 8.387l-4.552.361c-1.775.14-2.495 2.331-1.142 3.477l3.468 2.937-1.06 4.392c-.413 1.713 1.472 3.067 2.992 2.149L12 19.35l3.897 2.354c1.52.918 3.405-.436 2.992-2.15l-1.06-4.39 3.468-2.938c1.353-1.146.633-3.336-1.142-3.477l-4.552-.36-1.754-4.17Z" />
                        </svg>
                        <span class="font-medium text-xl">{{ generics.user_subjects_avg_rating|floatformat:0 }}</span>
                    </div>
                    <span class="text-muted">5 баллдық шкаламен</span>
                </div>
            </div>
        </div>

        <!-- БЖБ және ТЖБ бойынша жиынтық бағалау -->
        <div class="grid gap-4 border-b border-border-200 pb-8">
            <h1 class="text-2xl font-medium">БЖБ және ТЖБ бойынша жиынтық бағалау</h1>
            
            <table class="w-full border border-border-200">
                <thead class="bg-secondary-100">
                    <tr>
                        <th class="border border-border-200 p-2">№</th>
                        <th class="border border-border-200 p-2">Түрі</th>
                        <th class="border border-border-200 p-2">Оқушы</th>
                        <th class="border border-border-200 p-2">Макс. балл</th>
                        <th class="border border-border-200 p-2">0–39%</th>
                        <th class="border border-border-200 p-2">40–84%</th>
                        <th class="border border-border-200 p-2">85–100%</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in report_data %}
                        <tr>
                            <td class="border border-border-200 p-2">{{ forloop.counter }}</td>
                            <td class="border border-border-200 p-2">{{ row.lesson.title }}</td>
                            <td class="border border-border-200 p-2 text-center">{{ row.students_count }}</td>
                            <td class="border border-border-200 p-2 text-center">{{ row.max_score }}</td>
                            <td class="border border-border-200 p-2 text-center bg-red-300">{{ row.low }}</td>
                            <td class="border border-border-200 p-2 text-center bg-amber-300">{{ row.mid }}</td>
                            <td class="border border-border-200 p-2 text-center bg-green-300">{{ row.high }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="8" class="text-center py-8">Бұл тоқсанда жиынтық сабақтар жоқ</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Оқушылардың тоқсандық бағалар кестесі -->
        <div class="grid gap-4">
            <h2 class="text-2xl font-medium">Оқушылардың тоқсандық бағалары</h2>

            <div class="overflow-x-auto">
                <table class="w-full border border-border-200">
                    <thead class="bg-secondary-100">
                        <tr>
                            <th rowspan="2" class="border border-border-200 p-2">№</th>
                            <th rowspan="2" class="border border-border-200 p-2">Аты-жөні</th>
                            <th rowspan="2" class="border border-border-200 p-2">Формативті бағалар</th>

                            <!-- Динамикалық БЖБ бағандары -->
                            {% for ch in chapter_lessons %}
                                <th class="border border-border-200 p-2 text-center">БЖБ №{{ forloop.counter }}</th>
                            {% empty %}
                                <th class="border border-border-200 p-2 text-center">БЖБ жоқ</th>
                            {% endfor %}

                            <!-- ТЖБ -->
                            {% if quarter_lesson %}
                                <th class="border border-border-200 p-2 text-center">ТЖБ</th>
                            {% endif %}

                            <th rowspan="2" class="border border-border-200 p-2 text-center">ФБ + БЖБ (%)</th>
                            <th rowspan="2" class="border border-border-200 p-2 text-center">ТЖБ (%)</th>
                            <th rowspan="2" class="border border-border-200 p-2 text-center">Жиынтық (%)</th>
                            <th rowspan="2" class="border border-border-200 p-2 text-center">Тоқсандық баға</th>
                        </tr>
                        <tr>
                            {% for ch in chapter_lessons %}
                                <th class="border border-border-200 p-2 text-center text-muted font-normal">
                                    Макс: {{ ch.max_rating|default:0 }}
                                </th>
                            {% empty %}
                                <th class="border border-border-200 p-2 text-center text-muted font-normal">–</th>
                            {% endfor %}

                            {% if quarter_lesson %}
                                <th class="border border-border-200 p-2 text-center text-muted font-normal">
                                    Макс: {{ quarter_lesson.max_rating|default:0 }}
                                </th>
                            {% endif %}
                        </tr>
                    </thead>

                    <tbody>
                        {% for s in students_data %}
                            <tr class="hover:bg-secondary-50">
                                <td class="border border-border-200 p-2 text-center">{{ forloop.counter }}</td>
                                <td class="border border-border-200 p-2">{{ s.student.get_full_name }}</td>
                                <td class="border border-border-200 p-2 text-center w-96">
                                    <div class="flex gap-1 overflow-x-auto">
                                        {% if s.lesson_grades %}
                                            {% for g in s.lesson_grades %}
                                                <span class="block whitespace-nowrap px-2 py-1 rounded bg-blue-100 text-blue-800">{{ g }}</span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-gray-400 italic">—</span>
                                        {% endif %}
                                    </div>
                                </td>
                                {% for g in s.chapter_grades %}
                                    <td class="border border-border-200 p-2 text-center">
                                        {% if g != '-' %}
                                            <span>{{ g }}</span>
                                        {% else %}
                                            <span>—</span>
                                        {% endif %}
                                    </td>
                                {% endfor %}
                                <td class="border border-border-200 p-2 text-center font-medium">
                                    {% if s.quarter_grade != '-' %}
                                        <span>{{ s.quarter_grade }}</span>
                                    {% else %}
                                        <span>—</span>
                                    {% endif %}
                                </td>
                                <td class="border border-border-200 p-2 text-center font-medium">
                                    {{ s.fb_bjb_percent }}%
                                </td>
                                <td class="border border-border-200 p-2 text-center font-medium">
                                    {{ s.tjb_percent }}%
                                </td>
                                <td class="border border-border-200 p-2 text-center font-medium">
                                    {{ s.total_percent }}%
                                </td>
                                <td class="border border-border-200 p-2 text-center font-medium">
                                    {{ s.quarter_mark }}
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="{{ chapter_lessons|length|add:4 }}" class="text-center py-6 text-gray-500 italic">
                                    Бұл тоқсанда бағалар жоқ
                                </td>
                            </tr>
                        {% endfor %}
                        <tr class="bg-primary-50 font-semibold">
                            <td colspan="{{ chapter_lessons|length|add:4 }}" class="p-2">Жалпы көрсеткіштер:</td>
                            <td class="border border-border-200 p-2 text-center">
                                {{ averages.fb_bjb_avg }}%
                            </td>
                            <td class="border border-border-200 p-2 text-center">
                                {{ averages.tjb_avg }}%
                            </td>
                            <td class="border border-border-200 p-2 text-center">
                                {{ averages.total_avg }}%
                            </td>
                            <td class="border border-border-200 p-2 text-center">
                                {{ averages.mark_avg|floatformat:0 }}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock base_layout %}
